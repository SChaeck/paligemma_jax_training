# =============================================================================
# PaliGemma Training Configuration - RefCOCOg Dataset (OpenPI pi0.5_base)
# =============================================================================
# This configuration trains PaliGemma on the RefCOCOg referring expression
# comprehension dataset using OpenPI pi0.5_base weights.
#
# RefCOCOg Task: Given an image and a natural language description,
# predict the bounding box [x, y, width, height] of the referred object.
#
# Usage:
#   python scripts/03_train_production.py --env envs/.env.openpi.10000.refcocog
# =============================================================================

# =============================================================================
# Dataset Type - RefCOCOg
# =============================================================================
DATASET_TYPE=refcocog

# =============================================================================
# Debugging Flags - Enable comprehensive debugging output
# =============================================================================
# DEBUG_TRAINING=1
# MODEL_DEBUG_EMBEDDING=1
# MODEL_DEBUG_FORWARD=1
# VALIDATE_BATCH_IMAGES=1

# Experiment name
EXPERIMENT_NAME=pi05_refcocog_training

# =============================================================================
# Model Configuration
# =============================================================================
MODEL_CHECKPOINT_PATH=./checkpoints/pi05_base_paligemma.npz
MODEL_TOKENIZER_PATH=./assets/paligemma_tokenizer.model

# Model architecture
MODEL_LLM_VARIANT=gemma_2b
MODEL_VOCAB_SIZE=257152
MODEL_IMG_SIZE=224
MODEL_IMG_VARIANT=So400m/14
MODEL_IMG_POOL_TYPE=none
MODEL_IMG_SCAN=true
MODEL_IMG_DTYPE_MM=float16

# =============================================================================
# Training Configuration
# =============================================================================
TRAINABLE_PARAMS=full_model
LEARNING_RATE=1e-5
LR_SCHEDULE=cosine
WARMUP_PERCENT=0.10

# Batch size and epochs
PRECISION=bfloat16           
USE_PMAP=false                
BATCH_SIZE=4
NUM_EPOCHS=20
GRADIENT_ACCUMULATION_STEPS=8

# Gradient clipping
MAX_GRAD_NORM=1.0

# Random seed
SEED=42

# =============================================================================
# Data Configuration - RefCOCOg
# =============================================================================
DATA_BASE_DIR=/workspace/paligemma_jax_training/../XVR
DATA_TRAIN_FILE=train.jsonl
DATA_VALID_FILE=val.jsonl
DATA_IMAGE_DIR=images

# Sequence settings
MAX_SEQ_LENGTH=512
SHUFFLE_BUFFER_SIZE=1000

# Prompt prefix (empty by default)
PROMPT_PREFIX=

# Training strategy
TRAIN_ON_PREFIX=0

# Multi-image handling (RefCOCOg has single images, but we keep consistency)
USE_IMAGE_GRID=0
MAX_IMAGES=1

# Sample limits
MAX_TRAIN_SAMPLES=10000
MAX_EVAL_SAMPLES=1000

# =============================================================================
# Logging and Checkpointing
# =============================================================================
OUTPUT_DIR=./outputs/refcocog_openpi

LOG_EVERY=1
EVAL_EVERY=50
CHECKPOINT_EVERY=200
MAX_CHECKPOINTS_TO_KEEP=3

# Weights & Biases
USE_WANDB=true
WANDB_PROJECT=paligemma-refcocog-openpi
WANDB_ENTITY=schaeck
WANDB_MODE=online

# =============================================================================
# Evaluation Configuration
# =============================================================================
EVAL_BATCH_SIZE=8
EVAL_SAMPLER=greedy

# =============================================================================
# System Configuration
# =============================================================================
XLA_MEM_FRACTION=0.9
TF_ALLOW_GROWTH=true
BIG_VISION_PATH=/workspace/paligemma_jax_training/../big_vision
